{% extends "global/Base.html" %}
{% load staticfiles otree %}

{% comment %}
    
    Eli Pandolfo <epandolf@ucsc.edu>

    otree redwood:
        if you call any function that calls 'channel.send()' in the plain javascript or within
        the Vue machine, you will get an error saying channel does not have a method called
        send.

        However, if you call the function from the HTML or from a function that runs automatically
        such as window.onload, it works fine.
    
{% endcomment %}

{% block scripts %}

    <script src="{% static "js/vue.js" %}"></script>
    <script type='text/javascript'>
        // time when user enters the queue room
        // might want to change this to when all players arrive
        window.onload = function () {
            document.getElementById('arrive_time').value = new Date().toISOString()
        }
        
        // time when a player enters the service room 
        time_sr = function() {
            document.getElementById('sr_time').value = new Date().toISOString()
        }

        // Boilerplate that lets you access useful oTree template variables from Javascript.
        var oTree = oTree || {};
        (function() {
            oTree.group = parseInt("{{ player.group.pk }}");
            oTree.group = isNaN(oTree.group) ? null : oTree.group;
            oTree.role = "{{ player.role }}";
            oTree.participantCode = "{{ player.participant.code }}";
            oTree.appName = "{{ subsession.app_name }}";
            oTree.idInGroup = "{{ player.id_in_group }}";
            oTree.csrfToken = "{{ csrf_token }}";
            {% if view.is_debug %}
            oTree.debug = true;
            {% else %}
            oTree.debug = false;
            {% endif %}
        })();

        // Log period start/end to the JavaScript console.
        document.querySelector("redwood-period").addEventListener('period-start', function(event) {
            console.log('period started');
        });
        document.querySelector("redwood-period").addEventListener('period-end', function(event) {
            console.log('period ended');
        });

        var vm = new Vue({
            delimiters: ['{', '}'],
            el: '#app',
            data: function() {
                return {

                    // player data
                    pay_rate: {{ pay_rate_ | json }},
                    service_time: {{ service_time_ | json }},
                    time_spent_in_front: 0,
                    ID: {{ id | json }},
                    served: false,

                    //group data
                    start_time: null,
                    now: null,
                    num_players: {{ num_players_ | json }},
                    num_players_queue: {{ num_players_ | json }},
                    num_players_service: 0,
                    position: {{ start_pos_ | json }},
                    in_trade: false, // state
                    requested: null, // person
                    requesting: null, // person
                    period_length: {{ round_time_ | json }},
                    accumulated: 0.00,
                    accepted: 2,
                    current_alert: '',
                    display_alert: '',
                    alert_duration: 3.5, //duration in s an alert is shown
                    alert_fadeout: 1, // duration in s an alert fades out
                    alert_opacity: 1,
                    dur: 0,
                    alert_interval: null,
                    last_event: null,
                    trade_allowed: { // these are positions not IDs
                        1: true,
                        2: true,
                        3: true,
                        4: true,
                        5: true,
                        6: true,
                        7: true,
                        8: true,
                        9: true,
                        10: true,
                    },
                    channel : document.getElementById('channel')
                }
            },
            created: function() {
                this.start_time = parseInt(new Date().getTime() / 1000)

                setInterval(function() {
                    this.now = parseInt(new Date().getTime() / 1000)
                }.bind(this), 999) // assume a 1 ms delay for all information transit and logic
            },
            // computed functions get called every time one of their dependencies changes
            computed: {
                // everytime this.now changes (once per second), this function is called
                time_remaining_period: function() {
                    return this.period_length - (this.now - this.start_time)
                },
                h: function() {
                    return this.num_players > 6 ? window.innerHeight : window.innerHeight * 0.55
                }
            },
            // watch functions are called every time the property associated with the function name
            // changes
            watch: {
                current_alert: function() {
                    clearInterval(this.alert_interval)
                    console.log(this.current_alert)
                    this.display_alert = this.current_alert
                    this.dur = 0
                    this.alert_opacity = 1
                    this.alert_interval = setInterval( function() {
                        if(this.dur >= this.alert_duration) {
                            this.display_alert = ''
                            clearInterval(this.alert_interval)
                        }
                        else if(this.dur >= this.alert_duration - this.alert_fadeout) {
                            this.alert_opacity = 1 - (this.dur - (this.alert_duration - this.alert_fadeout))
                            this.dur += 0.01
                        }
                        else {
                            this.dur += 0.01
                        }
                    }.bind(this), 10)
                },

                // gets called every time this.now is updated, every second
                now: function() {
                    if(this.served == true) {
                        this.accumulated += this.pay_rate
                    }
                    else {
                        if(this.position == 1) {
                            if(this.time_spent_in_front == this.service_time - 1) {
                                this.next()
                                time_sr()
                                this.served = true
                            }
                            else {
                                this.time_spent_in_front += 1
                            }
                        }  
                    }
                },
                // used to determine whether buttons are clickable
                last_event: function() {
                    for(var p in g_data) {
                        if (!this.in_trade && g_data.hasOwnProperty(p) && !g_data[p]['in_trade']) {
                            this.trade_allowed[g_data[p]['pos']] = true
                        }
                        else {
                            this.trade_allowed[g_data[p]['pos']] = false
                        }
                    }
                },
            },
            methods: {
                request: function(pos) {
                    for(var p in g_data) {
                        if (g_data.hasOwnProperty(p)) {
                            if(g_data[p]['pos'] == pos)
                                g_data[this.ID]['requesting'] = g_data[p]['id']
                        }
                    }   
                    this.update()
                },

                respond: function(yesno) {
                    g_data[this.ID]['accepted'] = yesno
                    this.update()
                },

                next: function() {
                    for(var p in g_data) {
                        if (g_data.hasOwnProperty(p)) {
                            g_data[p]['pos']--
                            g_data[p]['num_players_queue']--
                            g_data[p]['num_players_service']++
                            g_data[p]['next'] = true
                        }
                    }
                    this.update()
                },

                // sends g_data to server
                // state machine in server changes relevant fields then sends data back to client
                // eventListener sets received payload to g_data
                update: function() {
                    this.channel.send(g_data)
                }
            }
        })

        // component for queue player representation
        Vue.component( 'q-bubble', {
            delimiters: ['{', '}'],
            props: ['num_players', 'comp_pos', 'self_pos', 'requested'],
            computed: {
                trade_allowed: function() {
                    return vm.trade_allowed[this.comp_pos]
                }
            },
            template: `
                <div v-if="num_players >= comp_pos">
                    <div class="row padded-row">
                        <svg class="svg"> 
                            <circle cx="45" cy="60" r="40" v-if="comp_pos != self_pos"/>
                            <circle cx="45" cy="60" r="40" style="fill: #545353;" 
                                v-if="comp_pos == self_pos"/>
                            <text v-bind:x="40 - (parseInt(comp_pos / 10) * 4)" y="65" v-if="comp_pos != self_pos">
                                { comp_pos }
                            </text>
                            <text v-bind:x="40 - (parseInt(comp_pos / 10) * 4)" y="65" style="fill: whitesmoke;" v-if="comp_pos == self_pos">
                                { comp_pos }
                            </text>
                            <rect x="94" y="0" rx="3" ry="3" width="5" height="130"
                                style="fill: #545353;" v-if="comp_pos == 1"/>
                        </svg>
                    </div>
                    <div class="row btn-row">
                        <button type="button" class="btn btn-large"
                            style="margin-left: 20px;" v-if="comp_pos == self_pos - 1 && trade_allowed"
                            v-on:click="$emit('request', comp_pos)">Trade</button>
                        <button type="button" class="btn btn-large"
                            style="margin-left: 20px;" v-if="comp_pos == self_pos - 1 && !trade_allowed"
                            disabled>Trade</button>
                        <div class="col-6">
                            <button type="button" class="btn btn-large btn-yes"
                                v-if="comp_pos == self_pos + 1 && requested != null"
                                onclick="vm.respond(1)">Yes</button>
                        </div>
                        <div class="col-6">
                            <button type="button" class="btn btn-large btn-no"
                                v-if="comp_pos == self_pos + 1 && requested != null"
                                onclick="vm.respond(0)">No</button>
                        </div>
                    </div>
                </div>
            `
        })

        // component for service player representation
        Vue.component( 's-bubble', {
            delimiters: ['{', '}'],
            props: ['num_players', 'comp_pos', 'self_pos'],
            template: `
                <div class="col-4" v-if="num_players >= -comp_pos + 1">
                    <svg class="svg-s"> 
                        <circle cx="45" cy="60" r="40" style="fill: #545353;"
                            v-if="comp_pos == self_pos"/>
                        <circle cx="45" cy="60" r="40" v-if="comp_pos != self_pos"/>
                    </svg>
                </div>
            `
        })

        // all group data pertinent to swaps
        var g_data = {{ data | json }}

        // adds event listener to check for events sent by server over channel
        vm.channel.addEventListener('event', function(event) {
            
            // for debugging
            console.log(event.detail.channel) // "swap"
            //console.log(new Date().getTime())
            //console.log(event.detail.timestamp)
            console.log(event.detail.payload) // test_order

            g_data = event.detail.payload

            var p = g_data[vm.ID]
            vm.position = p.pos
            vm.in_trade = p.in_trade
            vm.requested = p.requested
            vm.requesting = p.requesting
            vm.accepted = p.accepted
            vm.current_alert = p.alert
            vm.num_players_queue = p.num_players_queue
            vm.num_players_service = p.num_players_service
            vm.last_event = parseInt(new Date().getTime() / 1000)
            //now, with reactivity, all of these fields should update in the html
            //need to do some logic that updates the actual html from here
        })


    </script>

    <!--Import the redwood-period webcomponent.-->
    <link rel="import"
        href="/static/otree-redwood/webcomponents/redwood-period/redwood-period.html">

{% endblock %}

{% block styles %}
    <style>
        .dev {
            border-style: solid;
            border-width: 1px;
        }
        .svg {
            margin-left: 9px;
        }
        .svg-s {
            margin-left: -7px;
        }
        .infobar {
            height: 60px;
            background-color: #dfdfdf;
        }
        .infoborder {
            border-right: solid;
            border-bottom: solid;
            border-width: 1px; 
            border-color: #c0c0c0;
        }
        .infocol {
            text-align: center;
            color: #545353;
            font-size: 18px;
            font-family: sans-serif;
        }
        .alertbar {
            text-align: center;
            color: #e23f36;
            height: 30px;
            background-color: #dfdfdf;
            border-bottom: solid;
            border-color: #c0c0c0;
            border-width: 1px;
        }
        .queue-1 {
            background-color: #f3f2f2;
        }
        .queue-2 {
            background-color: #fbfbfb;
        }
        .padded-row {
            margin-top: 30px;
        }
        .service {
            background-color: #f2f2f2;
        }
        .btn {
            background-color: #545353;
            color: whitesmoke;
        }
        .btn-row {
            margin-top: -30px;
            height: 40px;
        }
        .btn-yes {
            margin-left: -15px; background-color: #28b738;
        }
        .btn-no {
            margin-left: -15px; width: 220%; background-color: #e23f36;
        }
        .otree-timer {
            display: none;
        }
        circle {
            stroke: #545353;
            stroke-width: 3px;
            fill: none;
        }
        text {
            color: #545353;
            font-size: 16px;
            font-family: sans-serif;
        }
    </style>
{% endblock %}


{% block title %}
{% endblock %}

{% block content %}
    <!-- django form inputs -->
    <input type="hidden" name="time_Queue" id="arrive_time" />
    <input type="hidden" name="time_Service" id="sr_time" />

    <redwood-period></redwood-period>
    <redwood-channel
        id="channel"
        channel="swap">
    </redwood-channel>

    <div id="app">
        <input type="hidden" name="service_time" v-model="service_time" />
        <input type="hidden" name="pay_rate" v-model="pay_rate" />
        <input type="hidden" name="accumulated" v-model="accumulated.toFixed(2)" />
        <div class="row" v-bind:style="{ height: .775 * h + 'px;' }">
            <div class="col-12">
                <div class="row infobar">
                    <div class="col-2 infocol infoborder">
                        Round: <br>
                        {{ round_ }}
                    </div>
                    <div class="col-3 infocol infoborder">
                        Pay Rate: <br>
                        ${ pay_rate } / second
                    </div>
                    <div class="col-3 infocol infoborder">
                        Service Time: <br>
                        { service_time } seconds
                    </div>
                    <div class="col-2 infocol infoborder">
                        Accumulated: <br>
                        ${ accumulated.toFixed(2) }
                    </div>
                    <div class="col-2 infocol" style="font-size: 45px;
                        border-bottom: solid; border-width: 1px; border-color: #bbbbbb">
                        { time_remaining_period }
                    </div>
                </div>
                <div class="row alertbar">
                    <div class="col-8" v-bind:style="{ opacity: alert_opacity }">
                        { display_alert }
                    </div>
                </div>
                <div class="row" v-bind:style="{ height: .6625 * h + 'px;' }">
                    <div class="col-8 queue" style="border-width: 1px">
                        <div class="row" v-bind:style="{ height: (.6625 * h - 2) + 'px' }">
                            <div class="col-2 queue-1">
                                <q-bubble
                                    v-bind:num_players="num_players_queue"
                                    comp_pos="6"
                                    v-bind:self_pos="position"
                                    v-bind:requested="requested"
                                    v-on:request="request">
                                </q-bubble>
                                <q-bubble
                                    v-bind:num_players="num_players_queue"
                                    comp_pos="7"
                                    v-bind:self_pos="position"
                                    v-bind:requested="requested"
                                    v-on:request="request">
                                </q-bubble>
                            </div>
                            <div class="col-2 queue-2">
                                <q-bubble
                                    v-bind:num_players="num_players_queue"
                                    comp_pos="5"
                                    v-bind:self_pos="position"
                                    v-bind:requested="requested"
                                    v-on:request="request">
                                </q-bubble>
                                <q-bubble
                                    v-bind:num_players="num_players_queue"
                                    comp_pos="8"
                                    v-bind:self_pos="position"
                                    v-bind:requested="requested"
                                    v-on:request="request">
                                </q-bubble>
                            </div>
                            <div class="col-2 queue-1">
                                <q-bubble
                                    v-bind:num_players="num_players_queue"
                                    comp_pos="4"
                                    v-bind:self_pos="position"
                                    v-bind:requested="requested"
                                    v-on:request="request">
                                </q-bubble>
                                <q-bubble
                                    v-bind:num_players="num_players_queue"
                                    comp_pos="9"
                                    v-bind:self_pos="position"
                                    v-bind:requested="requested"
                                    v-on:request="request">
                                </q-bubble>
                            </div>
                            <div class="col-2 queue-2">
                                <q-bubble
                                    v-bind:num_players="num_players_queue"
                                    comp_pos="3"
                                    v-bind:self_pos="position"
                                    v-bind:requested="requested"
                                    v-on:request="request">
                                </q-bubble>
                                <q-bubble
                                    v-bind:num_players="num_players_queue"
                                    comp_pos="10"
                                    v-bind:self_pos="position"
                                    v-bind:requested="requested"
                                    v-on:request="request">
                                </q-bubble>
                            </div>
                            <div class="col-2 queue-1">
                                <q-bubble
                                    v-bind:num_players="num_players_queue"
                                    comp_pos="2"
                                    v-bind:self_pos="position"
                                    v-bind:requested="requested"
                                    v-on:request="request">
                                </q-bubble>
                            </div>
                            <div class="col-2 queue-2">
                                <q-bubble
                                    v-bind:num_players="num_players_queue"
                                    comp_pos="1"
                                    v-bind:self_pos="position"
                                    v-bind:requested="requested"
                                    v-on:request="request">
                                </q-bubble>
                            </div>
                        </div>
                    </div>
                    <div class="col-4 service">
                        <div class="row" v-bind:style="{ height: (.6625 * h - 2) + 'px' }">
                            <div class="col-12">
                                <div class="row padded-row" style="height: 100px;">
                                    <s-bubble
                                        v-bind:num_players="num_players_service"
                                        comp_pos=""
                                        v-bind:self_pos="position">
                                    </s-bubble>
                                    <s-bubble
                                        v-bind:num_players="num_players_service"
                                        comp_pos="-1"
                                        v-bind:self_pos="position">
                                    </s-bubble>
                                    <s-bubble
                                        v-bind:num_players="num_players_service"
                                        comp_pos="-2"
                                        v-bind:self_pos="position">
                                    </s-bubble>
                                </div>
                                <div class="row padded-row" style="height: 100px;"
                                        v-if="num_players > 3">
                                    <s-bubble
                                        v-bind:num_players="num_players_service"
                                        comp_pos="-3"
                                        v-bind:self_pos="position">
                                    </s-bubble>
                                    <s-bubble
                                        v-bind:num_players="num_players_service"
                                        comp_pos="-4"
                                        v-bind:self_pos="position">
                                    </s-bubble>
                                    <s-bubble
                                        v-bind:num_players="num_players_service"
                                        comp_pos="-5"
                                        v-bind:self_pos="position">
                                    </s-bubble>
                                </div>
                                <div class="row padded-row" style="height: 100px;"
                                        v-if="num_players > 6">
                                    <s-bubble
                                        v-bind:num_players="num_players_service"
                                        comp_pos="-6"
                                        v-bind:self_pos="position">
                                    </s-bubble>
                                    <s-bubble
                                        v-bind:num_players="num_players_service"
                                        comp_pos="-7"
                                        v-bind:self_pos="position">
                                    </s-bubble>
                                    <s-bubble
                                        v-bind:num_players="num_players_service"
                                        comp_pos="-8"
                                        v-bind:self_pos="position">
                                    </s-bubble>
                                </div>
                                <div class="row padded-row" style="height: 100px;"
                                        v-if="num_players > 9">
                                    <s-bubble
                                        v-bind:num_players="num_players_service"
                                        comp_pos="-9"
                                        v-bind:self_pos="position">
                                    </s-bubble>
                                    <s-bubble
                                        v-bind:num_players="num_players_service"
                                        comp_pos="-10"
                                        v-bind:self_pos="position">
                                    </s-bubble>
                                    <s-bubble
                                        v-bind:num_players="num_players_service"
                                        comp_pos="-11"
                                        v-bind:self_pos="position">
                                    </s-bubble>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% comment %}

    -   install redwood on server then test html rendering in leeps lab
    -   metadata
            player
                original pos
            group
                every request
                accept, time, etc
                state of queue after request
        
{% endcomment %}















